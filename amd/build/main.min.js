define(['core_form/modalform', 'core/notification', 'core/str'], function(ModalForm, Notification, Str) {
    function openWizard(courseid, step, draftid) {
    step = step || 1;
    draftid = draftid || 0;

    var saveKey = step < 3 ? 'submitnext' : 'submitfinal';
    return Promise.all([
        Str.get_string('pluginname', 'block_catquiz_feedbackwizard'),
        Str.get_string(saveKey, 'block_catquiz_feedbackwizard')
    ]).then(function(results) {
        var title = results[0];
        var saveText = results[1];
        var modalForm = new ModalForm({
            formClass: 'block_catquiz_feedbackwizard\\form\\wizard',
            args: {
                courseid: courseid,
                step: step,
                draftid: draftid},
            modalConfig: {
                title: title},
            saveButtonText: saveText
        });

        var closeModal = function() {
            if (typeof modalForm.close === 'function') {
                return modalForm.close(); // New Modal-API.
            } else if (modalForm.modal && typeof modalForm.modal.destroy === 'function') {
                modalForm.modal.destroy(); // Old Modal-API.
                return Promise.resolve();
            } else if (modalForm.modal && typeof modalForm.modal.hide === 'function') {
                modalForm.modal.hide(); // Fallback.
                return Promise.resolve();
            }
            return Promise.resolve();
        };

<<<<<<< Updated upstream
        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, function(e) {
            var response = e.detail || {};
            if (response.status === 'continue') {
                closeModal().then(function() {
=======
            var saveKey = step < 3 ? 'submitnext' : 'submitfinal';
            var cancelKey = step > 1 ? true : false;

            return Promise.all([
                Str.get_string('pluginname', 'block_catquiz_feedbackwizard'),
                Str.get_string(saveKey, 'block_catquiz_feedbackwizard'),
                Str.get_string('submitprevious', 'block_catquiz_feedbackwizard'),
            ]).then(function(results) {
                var title = results[0];
                var nextText = results[1];
                var backText = results[2];

                var modalForm = new ModalForm({
                    formClass: 'block_catquiz_feedbackwizard\\form\\wizard',
                    args: {
                        courseid: courseid,
                        step: step,
                        draftid: draftid},
                    modalConfig: {
                        title: title,
                        type: 'SAVE_CANCEL',
                        large: true,
                        scrollable: true,
                        showSaveButton: true,
                        showCancelButton: cancelKey},
                    saveButtonText: nextText
                });

                /**
                 * Closes the modal form using the appropriate API method.
                 *
                 * @returns {Promise} Promise that resolves when modal is closed
                 */
                var closeModal = function() {
                    if (typeof modalForm.close === 'function') {
                        return modalForm.close(); // Newer APIs
                    } else if (modalForm.modal && typeof modalForm.modal.destroy === 'function') {
                        modalForm.modal.destroy(); // Older Modal API
                        return Promise.resolve();
                    } else if (modalForm.modal && typeof modalForm.modal.hide === 'function') {
                        modalForm.modal.hide(); // Fallback
                        return Promise.resolve();
                    }
                    return Promise.resolve();
                };

                /**
                 * Handles the continue status response.
                 *
                 * @param {Object} response The response object from form submission
                 * @returns {Promise} Promise chain for continue handling
                 */
                var handleContinueStatus = function(response) {
>>>>>>> Stashed changes
                    Notification.addNotification({message: response.message, type: 'success'});
                    openWizard(courseid, response.nextstep, response.draftid).catch(Notification.exception);
                });
            } else if (response.status === 'submitted') {
                closeModal().then(function() {
                    Notification.addNotification({message: response.message, type: 'success'});
<<<<<<< Updated upstream
                });
            }
        });
        modalForm.addEventListener(modalForm.events.FORM_CANCELLED, function() {
            closeModal();
        });
        modalForm.show();
    }).catch(Notification.exception);
}
return {
    init: function() {
        document.addEventListener('click', function(e) {
            var trigger = e.target.closest('.js-open-catquiz_feedbackwizard[data-action="open-wizard"]');
            if (!trigger) {
                return;
            }
            e.preventDefault();
            var courseid = parseInt(trigger.getAttribute('data-courseid'), 10) || 0;
            openWizard(courseid, 1, 0).catch(Notification.exception);
        });
    }
};
});

=======
                };

                // Handle form submission events.
                modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, function(e) {
                    var response = e.detail || {};

                    if (response.status === 'continue') {
                        closeModal()
                            .then(function() {
                                return handleContinueStatus(response);
                            })
                            .catch(Notification.exception);

                    } else if (response.status === 'submitted') {
                        closeModal()
                            .then(function() {
                                handleSubmittedStatus(response);
                            })
                            .catch(Notification.exception);
                    }
                });

                // Handle form cancellation events.
                modalForm.addEventListener(modalForm.events.FORM_CANCELLED, function() {
                    closeModal().catch(Notification.exception);
                });

                modalForm.show().then(function() {
                    // Manipulate Cancel-Button after showing up.
                    var cancelBtn = document.querySelector('.modal-footer .btn-secondary');
                    if (cancelBtn) {
                        if (cancelKey) {
                            cancelBtn.textContent = backText;
                        } else {
                            cancelBtn.style.display = 'none';
                        }
                    }
                });

            }).catch(Notification.exception);
        }

        return {
            /**
             * Initialize the feedback wizard functionality.
             *
             * Sets up event listeners for wizard trigger buttons and handles
             * the opening of the wizard modal when triggered.
             *
             * @returns {void}
             */
            init: function() {
                document.addEventListener('click', function(e) {
                    var trigger = e.target.closest('.js-open-catquiz_feedbackwizard[data-action="open-wizard"]');
                    if (!trigger) {
                        return;
                    }
                    e.preventDefault();
                    var courseid = parseInt(trigger.getAttribute('data-courseid'), 10) || 0;
                    openWizard(courseid, 1, 0).catch(Notification.exception);
                });
            }
        };
    });
>>>>>>> Stashed changes
